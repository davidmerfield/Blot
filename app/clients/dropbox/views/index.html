<div class="dropbox">
{{#account}}

  <a class="line" href="/settings/client/switch">
    <span class="label">Synced with</span>
    <span class="center">Dropbox</span>
    <span class="right">Edit</span>
  </a>


  <!-- <div class="line">
    <p><b>Dropbox</b> {{#preparing}}is preparing to synchronize{{/preparing}} {{^preparing}}synchronizes{{/preparing}} your folder. You can <a class="link" href="/settings/client/switch">switch to a different service or tool</a>.</p>
  </div> -->

  <div class="line">
    <div class="label">Status</div>
    <div class="center" style="padding-left: 26px;position: relative;">
      {{^error_code}}
      {{#preparing}}
<span class="spinner" style="position: absolute;left:1px;top:1px"><span class="bounce1"></span></span>
      <span id="status">Setting up folder on Dropbox</span>
      {{/preparing}}
      {{^preparing}}
      
      <span style="right:auto;left:-2px;transform: scale(0.8)" id="inputMessage" class="inputMessage success"></span>      
      <span id="status">Synced {{blog.updated}}</span>

      {{/preparing}}
       {{/error_code}}

      {{#error_code}}

      <a href="{{{base}}}/redirect{{#full_access}}?full_access=true{{/full_access}}" class="mess error">

        <b>Error</b><br><br>

        Blot cannot sync the folder for <b>{{blog.title}}</b>. You can probably fix this by reconnecting to Dropbox. If you can't fix this, please contact support. <br><br>

        <span class="button">Re-connect to Dropbox</span>
      </a>

      {{/error_code}}
    </div>
  </div>

  {{#dropboxBreadcrumbs.length}}
  <div class="line">
    <div class="label">Location on Dropbox</div>
    <div class="center">
      {{> location}}
   </div>
  </div>
  {{/dropboxBreadcrumbs.length}}

  {{#email}}
  {{^preparing}}
  <a class="line" href="{{{base}}}/edit">
  {{/preparing}}
  {{#preparing}}
  <div class="line">
  {{/preparing}}
    <span class="label">Account on Dropbox</span>
    <span class="center">{{email}}</span>
    {{^preparing}}
    <span class="right">Edit</span>    
    {{/preparing}}
  {{^preparing}}
  </a>
  {{/preparing}}
  {{#preparing}}
  </div>
  {{/preparing}}
  {{/email}}

  {{^preparing}}
  <a class="line" href="{{{base}}}/permission">
  {{/preparing}}
  {{#preparing}}
  <div class="line">
  {{/preparing}}
    <span class="label">Permission</span>
    {{#full_access}}
    <span class="center">Full folder</span>
    {{/full_access}}
    {{^full_access}}
    <span class="center">Apps folder only</span>
    {{/full_access}}
    {{^preparing}}
    <span class="right">Edit</span>    
    {{/preparing}}
  {{^preparing}}
  </a>
  {{/preparing}}
  {{#preparing}}
  </div>
  {{/preparing}}

  <a class="line" href="{{{base}}}/disconnect">
    <span class="label">Disconnect</span>
    <span class="link">Disconnect your folder from Dropbox</span>
  </a>

<br><br>

{{/account}}
</div>

<style type="text/css">.label {flex-basis:30%}</style>
<style type="text/css">
.inputMessage.working {background:#ff9800;display: block;}

.spinner > span {
  width: 1em;
  height: 1em;
  font-size: 0.8em;
  background-color: #ff9800;
  border-radius: 100%;
  display: inline-block;
  -webkit-animation: sk-bouncedelay 1.4s infinite ease-in-out both;
  animation: sk-bouncedelay 1.4s infinite ease-in-out both;
}


@-webkit-keyframes sk-bouncedelay {
  0%, 80%, 100% { -webkit-transform: scale(0) }
  40% { -webkit-transform: scale(1.0) }
}

@keyframes sk-bouncedelay {
  0%, 40%, 100% { 
    -webkit-transform: scale(0.9);
    transform: scale(0.9);
  } 70% { 
    -webkit-transform: scale(0.3);
    transform: scale(0.3);
  }
}

</style>

<script type="text/javascript">
  var evtSource = new EventSource("{{{dashboardBase}}}/status");
  var currentlyLoading;
  var lastStatus;
  var checkAgain;

  evtSource.onmessage = function(event) {

    // Fetch the latest folder state if we're not
    // already fetching it.
    if (currentlyLoading) {
      checkAgain = true;
      return;
    }

    currentlyLoading = true;

    loadFolder(function onLoad(){

      if (checkAgain === true) {
        checkAgain = false;
        return loadFolder(onLoad);
      }

      currentlyLoading = false;
    });

    lastStatus = event.data;
    document.getElementById('status').innerHTML = lastStatus;
  }


  function loadFolder (callback) {
   
    var xhr = new XMLHttpRequest();

    xhr.onreadystatechange = function (e) { 
      if (xhr.readyState == 4 && xhr.status == 200) {
        var parser = new DOMParser();
        var xml = parser.parseFromString(xhr.responseText, "text/html");
        var currentState = document.querySelector('.dropbox').innerHTML;
        var newState = xml.querySelector('.dropbox').innerHTML;
        if (newState === currentState) return callback();
        document.querySelector('.dropbox').innerHTML = newState;
        var statusDiv = document.getElementById('status');
        if (statusDiv) statusDiv.innerHTML = lastStatus;
        callback();
      }
    }

    xhr.open("GET", window.location, true);
    xhr.setRequestHeader('Content-type', 'text/html');
    xhr.send();
  }
</script>
