root /;

# The caching folders include the protocol in the path, so that redirects
# from HTTP to HTTP can be handled at the Node.js application. I figure
# this isn't important here so we have no protocol in the folder structure
# use $request_uri if you want the query string also
# use $uri if you don't want the query string
set $permanent_cache $cache_directory/$blot_host/$scheme/permanent$request_uri;

# Stores the cached images, avatars and thumbnails
# for the given blog
set $static_directory $blot_directory/static;

error_page 502 /error-proxy-502.html;

location = /error-proxy-502.html {
  client_max_body_size 1M;
  root  $blot_directory/app/views;
}

client_max_body_size 1M;

# Example CDN url: https://cdn.blot.im/blog_xyz/_image/name.jpg
location / {
  add_header 'Blot-Cache' 'true-static' always;
  add_header 'Cache-Control' 'public,max-age=31536000,immutable' always;
  add_header 'Access-Control-Allow-Origin' '*';
  gzip on;
  try_files $static_directory @blot;
}

location @permanent_cache {
  add_header 'Blot-Cache' 'true-permanent' always;
  add_header 'Cache-Control' 'public,max-age=31536000,immutable' always;
  add_header 'Access-Control-Allow-Origin' '*';
  gzip on;
  try_files $permanent_cache @blot;  
}

location @blot {
  gzip on;
  include /var/www/blot/config/nginx/reverse-proxy.conf;
}