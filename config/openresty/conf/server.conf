{{> initial.conf}}

http {

    {{> http.conf}}
    
    # blot subdomains (e.g. david.blot.im)
    server {
        listen 80;
        listen 443 ssl {{^disable_http2}}http2{{/disable_http2}};

        # match all subdomains of blot.im which do not start with preview-
        # e.g. blog-on-david.blot.im
        server_name "~^(?!preview-)[^.]+\.{{host}}$";
        
        {{> wildcard-ssl.conf}}

        {{> blot-blogs.conf}}
    }

    # preview subdomains (e.g. preview-of-blog-on-david.blot.im)
    server {
        listen 80;
        listen 443 ssl {{^disable_http2}}http2{{/disable_http2}};
        server_name "~^preview-[^.]+\.{{host}}$";

        {{> wildcard-ssl.conf}}
        
        location / {
            {{> reverse-proxy.conf}}
        }
    }

    # blot.im
    server {
        listen 443 ssl {{^disable_http2}}http2{{/disable_http2}};
        server_name {{host}}; 

        {{> wildcard-ssl.conf}}

        {{> blot-site.conf}}
    }

    # webhooks relay at webhooks.blot.im
    server {
        listen 443 ssl {{^disable_http2}}http2{{/disable_http2}};
        server_name webhooks.{{host}}; 

        {{> auto-ssl.conf}}

        location / {
            proxy_pass http://blot_node;
            proxy_read_timeout 24h;
            proxy_send_timeout 24h;
            proxy_connect_timeout 24h;
            
            # SSE-specific configurations
            proxy_http_version 1.1;      # SSE requires HTTP/1.1
            proxy_set_header Connection '';  # Disable keep-alive
            proxy_buffering off;         # Disable response buffering
            proxy_cache off;             # Ensure no caching

            # Failover behavior
            proxy_next_upstream off;     # Do not failover during SSE
        }
    }

    # custom domains
    server {
        listen 80 default_server;
        listen 443 ssl {{^disable_http2}}http2{{/disable_http2}} default_server;
        {{> auto-ssl.conf}}
        {{> blot-blogs.conf}}
    }    

    # redirect blot.im over HTTP to HTTPS
    server {
        listen 80;
        server_name {{host}}; 
        return 301 https://$host$request_uri;
    }

    # internal server for inspecting and purging the cache
    server {
       listen 127.0.0.1:80;
        {{#openresty_instance_private_ip}}
        # needed by the node application running inside docker
        # which doesn't have access to the host network
        # this seems to cause errors for custom domains
        # and overrides the default server
        listen {{openresty_instance_private_ip}}:8077;
        {{/openresty_instance_private_ip}}
            
        location = /inspect {
            content_by_lua_block {
                cacher:inspect(ngx)
            }
        }

        location = /rehydrate {
            content_by_lua_block {
                local message = cacher:rehydrate(ngx)
                ngx.say(message)
            }
        }

        location = /purge {
            content_by_lua_block {
                cacher:purge(ngx)
            }
        }

        # otherwise, return 404
        location / {
            return 404;
        }
    }
}